package ch.hurz.webcollab.server;

import java.util.Set;

import ch.hurz.webcollab.client.MessagingService;
import ch.hurz.webcollab.client.LoginFailureException;

import com.google.appengine.api.channel.ChannelMessage;
import com.google.appengine.api.channel.ChannelService;
import com.google.appengine.api.channel.ChannelServiceFactory;
import com.google.gwt.dev.util.collect.Sets;
import com.google.gwt.user.server.rpc.RemoteServiceServlet;

/**
 * The server side implementation of the RPC service.
 */
@SuppressWarnings("serial")
public class CollabServiceImpl extends RemoteServiceServlet implements
		MessagingService {

	private final Set<String> clients = Sets.create();

	@Override
	public String login(final String name, final String password)
			throws LoginFailureException {
		final ChannelService channelService = ChannelServiceFactory
				.getChannelService();
		final String channelKey = channelService.createChannel(name);
		clients.add(channelKey);
		return channelKey;
	}

	@Override
	public void broadcast(final String sendersClientToken, final String message) {
		for (final String token : clients) {
			if (!token.equals(sendersClientToken)) {
				sendMessage(token, message);
			}
		}
	}

	private void sendMessage(final String token, final String message) {
		final ChannelService channelService = ChannelServiceFactory
				.getChannelService();
		channelService.sendMessage(new ChannelMessage(token, message));
	}
}
